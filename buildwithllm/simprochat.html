<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SimProChat</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Anek+Latin:wght@100..800&family=Sen:wght@400..800&display=swap" rel="stylesheet">
<style>
html,body {height: 100%; overflow: hidden; font-family: "Anek Latin", sans-serif; font-weight: 300;}
body { margin: 0; padding: 0; display: flex; flex-direction: column; background: #f0f0f0; height: 100vh;}
pre {margin: 0;}
#apiKeySection { padding: 10px; background: #e0e0e0; cursor: pointer; position: relative; transition: all 0.3s ease; }
#apiKeySection.hidden { height: 5px; padding: 0; overflow: hidden; background-color: #e0e0e0; border-top: 1px solid #aeaeae; }
#apiKeySection.hidden input { display: none; }
#apiKeySection:after { content: ''; display: block; width: 100%; height: 1px; background: #e0e0e0; position: absolute; top: 0; left: 0; }
#apiKeySection.hidden:after { display: none; }
#mainContent {display: flex; flex: 1; overflow: hidden; max-width: 100vw;}
#mainColumn {flex: 1; display: flex; flex-direction: column; padding: 10px; background: #fff; position: relative; overflow-x: hidden;}
#sidebar { width: 300px; padding: 10px; display: flex; flex-direction: column; overflow-y: auto; background: #fff; transition: width 0.3s ease, padding 0.3s ease; }
#sidebar.hidden { width: 0; padding: 0; overflow: hidden; }
#sidebarToggle { width: 5px; background: #e0e0e0; color: #333; cursor: pointer; transition: background 0.3s ease; }
#sidebarToggle:hover { background: #aeaeae; }
@media (max-width: 768px) {
    #mainContent { flex-direction: column; }
    #mainColumn { min-height: 100%;}    
    #sidebar { display: none; }
}
#chatContainer {flex: 1; display: flex; position: relative; overflow: hidden;}
.chatRow {display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; padding: 3px; border-radius: 5px; position: relative;}
.editableText {line-height: 1.2; border: 1px solid transparent; padding: 5px; border-radius: 3px; display: inline-block; cursor: default; width: calc(100% - 10px); white-space: pre-wrap; word-wrap: break-word;}
.editableText:focus {outline: none;}
.editingMode {border: 2px solid #328be9; border-radius: 5px; padding: 5px; cursor: text;}
.messageRole {font-weight: bold; margin-bottom: 5px; display: block;}
#zeroshotHistory {margin-top: 10px; max-height: 300px; overflow-y: auto;}
textarea,input {width: 100%; box-sizing: border-box; padding: 5px; border: 1px solid #ccc; border-radius: 3px; margin-bottom: 5px;}
#chatHistory {flex: 1; overflow-y: auto; margin: 0 20px;}
#chatInput {padding: 10px; border-top: 1px solid #ccc;}
#errorMessage {color: red; padding: 10px;}
button {padding: 5px 10px; background: #328be9; color: #fff; border: none; border-radius: 3px; cursor: pointer;}
button:hover {background: #0056b3;}
@keyframes spin {0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);}}
.loadingSpinner {display: inline-block; width: 10px; height: 10px; border: 2px solid rgba(255, 255, 255, .3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-right: 5px;}
button:disabled {opacity: 0.7; cursor: not-allowed;}
#youtubeSection {margin-bottom: 10px;}
#youtubeFrame {width: 100%; height: 200px; border: none;}
#youtubeUrl {text-align: left;}
pre.codeblock {background-color: #f4f4f4; border-radius: 3px; padding: 20px 10px; position: relative; white-space: pre; word-wrap: norma; overflow-x: auto; margin-top: 5px; max-width: 100%; flex-shrink: 1;}
pre.codeblock code {font-family: 'Courier New', Courier, monospace; font-size: 14px; display: block; padding-top: 5px;}
.codeLanguage {font-size: 0.8em; color: #888; position: absolute; top: 0; left: 0; padding: 2px 5px; background: #e0e0e0; border-bottom-right-radius: 3px; border-right: 1px solid #ddd; border-bottom: 1px solid #ddd;}
.copyButton {position: absolute; top: 5px; right: 5px; background: white; color: #328be9; border: 1px solid #328be9; border-radius: 3px; padding: 2px 5px; cursor: pointer; font-size: 12px;}
.copyButton:hover {background: #328be9; color: white;}
.previewButton {position: absolute; bottom: 5px; right: 5px; background: white; color: green; border: 1px solid green; border-radius: 3px; padding: 2px 5px; cursor: pointer; font-size: 12px;}
.previewButton:hover {background: green; color: white;}
.navButton:disabled {color: #aaa; cursor: not-allowed; background: rgba(0, 0, 0, 0.05);}
#chatHistoryNavigation {display: flex; justify-content: space-between; align-items: center; padding: 0px; border-bottom: 1px solid #ccc; margin-bottom: 10px;}
.iconButton {background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px 10px; margin: 0 5px; transition: background-color 0.3s; border-radius: 5px; color: #328be9;}
.iconButton:hover {background-color: #e0e0e0;}
.iconButton:disabled {opacity: 0.25; cursor: not-allowed;}
#currentChatIndex {font-size: 16px; font-weight: 500; margin: 0 10px;}
#deleteChatButton {color: #328be9; left:0px;}
#deleteChatButton:hover {background-color: #328be933;}
</style>
</head>
<body>
<div id="apiKeySection" onclick="this.classList.toggle('hidden');"><input type="password" id="apiKeyInput" placeholder="This is a BYO-OpenAI-API-key interface, pointing to the `chatgpt-4o-latest` model; nothing is stored on the web page's hosting server." oninput="saveApiKey()" onclick="event.stopPropagation();"></div>
<div id="mainContent">
<div id="mainColumn">
<div id="chatHistoryNavigation">
<div>
<button id="prevChatButton" class="iconButton" onclick="prevConversation()" title="Previous Conversation">◀</button>
<span id="currentChatIndex">Loading..</span>
<button id="nextChatButton" class="iconButton" onclick="nextConversation()" title="Next Conversation">▶</button>
</div>
<button id="deleteChatButton" class="iconButton" onclick="deleteCurrentConversation()" title="Delete Current Conversation">⛒</button>
</div>
<div id="chatHistory"></div>
<div id="chatInput">
<textarea id="userInput" rows="3" placeholder="Enter your message... (Press Enter to send, Shift+Enter for new line)"></textarea>
<button id="sendButton" onclick="sendMessage()">Send</button>
</div>
</div>
<div id="sidebarToggle" onclick="toggleSidebar()"></div>
<div id="sidebar">
<div id="youtubeSection"><input type="text" id="youtubeUrl" value="https://www.youtube.com/embed/jfKfPfyJRdk?autoplay=1" placeholder="Enter YouTube embed URL" oninput="updateYoutubeUrl()"><iframe id="youtubeFrame" src="https://www.youtube.com/embed/jfKfPfyJRdk?autoplay=1" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe></div>
<h3>Zero-shot Query</h3>
<input type="text" id="zeroshotSystemPrompt" placeholder="Explain this in fewer words" value="Explain this in fewer words" style="margin-bottom: 10px; width: 100%; box-sizing: border-box;">
<div style="display: flex; align-items: center;"><textarea id="zeroshotInput" placeholder="Enter your zero-shot query..." style="flex-grow: 1; margin-top: 5px; min-height: 41px; height: 41px; box-sizing: border-box;"></textarea><button id="zeroshotButton" onclick="sendZeroshotQuery()" style="min-height: 40px; height: 40px; box-sizing: border-box; margin-left: 5px;">Ask</button></div>
<div id="zeroshotHistory"></div>
</div>
</div>
<div id="errorMessage"></div>
<script>
const apiUrl='https://api.openai.com/v1/chat/completions'; 
let chatHistory=[], zeroshotHistory=[], currentConversationIndex=-1, isMainChatProcessing=false, isZeroshotProcessing=false, db; 
let DEFAULT_SYSTEM_PROMPT="Response in fewer words, be concise and honest."; 

function openDB() {
const request=indexedDB.open('SimProChatDB', 1);
request.onupgradeneeded=function(event) {
db=event.target.result;
if (!db.objectStoreNames.contains('chatHistory')) {
db.createObjectStore('chatHistory', {keyPath:'id', autoIncrement:true});
}};
request.onsuccess=function(event) {
db=event.target.result;
startNewChat();
};
request.onerror=function(event) {
console.error('IndexedDB error:', event.target.errorCode);
};}

function startNewChat() {
    DEFAULT_SYSTEM_PROMPT = "Response in fewer words, be concise and honest.";
    currentConversationIndex = 0;
    chatHistory = [{ role: 'system', content: DEFAULT_SYSTEM_PROMPT }];
    updateChatDisplay();
    updateNavButtons();
    updateChatIndexDisplay();
}

function updateChatIndexDisplay() {
loadSortedChatIds().then(sortedChatIds=> {
const totalChats=sortedChatIds.length;
if (currentConversationIndex===0) {
document.getElementById('currentChatIndex').textContent=`New Chat (${totalChats+1})`;
} else {
const position=sortedChatIds.indexOf(currentConversationIndex)+1;
document.getElementById('currentChatIndex').textContent=`${position} of ${totalChats}`;
}}).catch(error=>{
console.error('Error updating chat index display:', error);
document.getElementById('currentChatIndex').textContent='#?';
});}

function loadSortedChatIds() {
return new Promise((resolve,reject)=>{
const transaction=db.transaction(['chatHistory'],'readonly');
const objectStore=transaction.objectStore('chatHistory');
const getAllKeysRequest=objectStore.getAllKeys();
getAllKeysRequest.onsuccess=function(event) {
const sortedChatIds=event.target.result.sort((a,b)=>a-b);
console.log('Sorted Chat IDs:', sortedChatIds);
resolve(sortedChatIds);
};
getAllKeysRequest.onerror=function(event) {
console.error('Error fetching sorted chat IDs:', event.target.errorCode);
reject(event.target.error);
};});}

function getCurrentChatPosition(sortedChatIds) {
return sortedChatIds.indexOf(currentConversationIndex)+1;
}

function getTotalChats() {
return new Promise((resolve,reject)=>{
const transaction=db.transaction(['chatHistory'],'readonly');
const objectStore=transaction.objectStore('chatHistory');
const countRequest=objectStore.count();
countRequest.onsuccess=function(event){
resolve(event.target.result);
};
countRequest.onerror=function(event){
reject(event.target.error);
};});}

function loadConversation() {
    console.log('Loading conversation with ID:', currentConversationIndex);
    const transaction = db.transaction(['chatHistory'], 'readonly');
    const objectStore = transaction.objectStore('chatHistory');
    const request = objectStore.get(currentConversationIndex);

    request.onsuccess = function(event) {
        const conversation = event.target.result;
        if (conversation) {
            chatHistory = conversation.messages || [];
            const systemPrompt = chatHistory.find(msg => msg.role === 'system');
            if (systemPrompt) {
                DEFAULT_SYSTEM_PROMPT = systemPrompt.content;
            } else {
                chatHistory.unshift({ role: 'system', content: DEFAULT_SYSTEM_PROMPT });
            }
        } else {
            // Handle the case for a new chat with no previous conversation
            DEFAULT_SYSTEM_PROMPT = "Response in fewer words, be concise and honest.";
            chatHistory = [{ role: 'system', content: DEFAULT_SYSTEM_PROMPT }];
        }
        console.log('Loaded conversation:', conversation);
        updateChatDisplay();
        updateNavButtons();
        updateChatIndexDisplay();
    };

    request.onerror = function(event) {
        console.error('Error loading conversation:', event.target.errorCode);
    };
}

function prevConversation() {
loadSortedChatIds().then(sortedChatIds=> {
if (sortedChatIds.length>0) {
if (currentConversationIndex===0) {
currentConversationIndex=sortedChatIds[sortedChatIds.length-1];
} else {
const currentIndex=sortedChatIds.indexOf(currentConversationIndex);
if (currentIndex>0) {
currentConversationIndex=sortedChatIds[currentIndex-1];
} else {
startNewChat();
return;
}}
loadConversation();
} else {
console.log('No saved conversations.');
}
updateNavButtons();
}).catch(error=>{
console.error('Error in prevConversation:', error);
});}

function nextConversation() {
loadSortedChatIds().then(sortedChatIds=>{
const currentIndex=sortedChatIds.indexOf(currentConversationIndex);
if (currentIndex<sortedChatIds.length-1) {
currentConversationIndex=sortedChatIds[currentIndex+1];
loadConversation();
updateNavButtons();
} else {
startNewChat();
}}).catch(error=>{
console.error('Error in nextConversation:', error);
});}

function deleteCurrentConversation() {
if (confirm("Are you sure you want to delete this conversation?")) {
const transaction=db.transaction(['chatHistory'],'readwrite');
const objectStore=transaction.objectStore('chatHistory');
const deleteRequest=objectStore.delete(currentConversationIndex);
deleteRequest.onsuccess=function(){
const getAllKeysRequest=objectStore.getAllKeys();
getAllKeysRequest.onsuccess=function(event){
const allKeys=event.target.result;
if (allKeys.length===0){
startNewChat();
} else {
currentConversationIndex=Math.max(...allKeys);
loadConversation();
}};};}}

function updateNavButtons() {
const prevButton=document.getElementById('prevChatButton');
const nextButton=document.getElementById('nextChatButton');
const deleteButton=document.getElementById('deleteChatButton');
loadSortedChatIds().then(sortedChatIds=>{
const totalChats=sortedChatIds.length;
prevButton.disabled=totalChats===0;
nextButton.disabled=currentConversationIndex===0;
deleteButton.disabled=currentConversationIndex===0;
updateChatIndexDisplay();
});}

function getNextConversationIndex() {
return new Promise((resolve,reject)=>{
const transaction=db.transaction(['chatHistory'],'readonly');
const objectStore=transaction.objectStore('chatHistory');
const request=objectStore.count();
request.onsuccess=function(event){
resolve(event.target.result);
};
request.onerror=function(event){
reject(event.target.errorCode);
};});}

function saveApiKey() {
localStorage.setItem('simproChatApiKey',document.getElementById('apiKeyInput').value);
}

function getApiKey() {
return localStorage.getItem('simproChatApiKey')||'';
}

function loadApiKey() {
document.getElementById('apiKeyInput').value=getApiKey();
}

function escapeHtml(html) {
return html.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function formatContent(content) {
let parts=[], lastIndex=0, codeBlockRegex=/```(\w+)?\n([\s\S]*?)```/g, match; 
while((match=codeBlockRegex.exec(content))!==null) {
if(match.index>lastIndex){parts.push(escapeHtml(content.substring(lastIndex,match.index)));}
const lang=match[1]||'plaintext',code=match[2],previewButton=lang==='html'?'<button class="previewButton" onclick="previewHTML(this)">Preview</button>':'';
parts.push(`<pre class="codeblock"><div class="codeLanguage">${lang}</div><code>${escapeHtml(code)}</code><button class="copyButton" onclick="copyCode(this)">Copy</button>${previewButton}</pre>`);
lastIndex=codeBlockRegex.lastIndex;}
if(lastIndex<content.length){parts.push(escapeHtml(content.substring(lastIndex)));}
return parts.join('');
}

function previewHTML(button) {
const codeElement=button.closest('pre').querySelector('code');
const newWindow=window.open('','_blank');
newWindow.document.write(codeElement.textContent.trim());
newWindow.document.close();
}

function createMessageElement(content,role,index) {
const div=document.createElement('div');
div.className='chatRow';
const contentDiv=document.createElement('div');
contentDiv.className='editableText normal';
contentDiv.contentEditable=true;
contentDiv.innerHTML=`<span class="messageRole">${role}:</span><div>${formatContent(content)}</div>`;
let isEditing=false;
contentDiv.addEventListener('dblclick',e=>{
if(!isEditing){
isEditing=true;
contentDiv.textContent=content;
contentDiv.classList.add('editingMode');
contentDiv.focus();
e.stopPropagation();
}});
contentDiv.addEventListener('keydown',e=>{
if(e.key==='Escape')finishEditing();
});
document.addEventListener('click',e=>{
if(isEditing&&!contentDiv.contains(e.target))finishEditing();
});
function finishEditing(){
isEditing=false;
content=contentDiv.textContent.trim();
contentDiv.classList.remove('editingMode');
contentDiv.innerHTML=`<span class="messageRole">${role}:</span><div>${formatContent(content)}</div>`;
if(index>=0)chatHistory[index].content=content;
else DEFAULT_SYSTEM_PROMPT=content;
}
div.appendChild(contentDiv);
return div;
}

function updateChatDisplay() {
    const chatHistoryDiv = document.getElementById('chatHistory');
    chatHistoryDiv.innerHTML = '';
    chatHistory.forEach((msg, index) => chatHistoryDiv.appendChild(createMessageElement(msg.content, msg.role, index)));
    chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
}

async function sendMessage() {
    if (isMainChatProcessing) return;
    const userInput = document.getElementById('userInput');
    if (userInput.value.trim() === '') return;

    const userMessage = { role: 'user', content: userInput.value };
    chatHistory.push(userMessage);

    updateChatDisplay();
    userInput.value = '';

    try {
        isMainChatProcessing = true;
        setButtonLoadingState('sendButton', true);
        const response = await fetchAIResponse(chatHistory); // chatHistory already includes the system prompt
        const assistantMessage = { role: 'assistant', content: response };
        chatHistory.push(assistantMessage);

        if (currentConversationIndex === 0) {
            saveNewChat();
        } else {
            updateExistingChat();
        }

        updateChatDisplay();
    } catch (error) {
        document.getElementById('errorMessage').textContent = `Error: ${error.message}`;
    } finally {
        isMainChatProcessing = false;
        setButtonLoadingState('sendButton', false);
    }
}

function saveNewChat() {
const transaction=db.transaction(['chatHistory'],'readwrite');
const objectStore=transaction.objectStore('chatHistory');
const request=objectStore.add({messages:chatHistory});
request.onsuccess=function(event){
currentConversationIndex=event.target.result;
updateNavButtons();
updateChatIndexDisplay();
};}

function updateExistingChat() {
const transaction=db.transaction(['chatHistory'],'readwrite');
const objectStore=transaction.objectStore('chatHistory');
const request=objectStore.put({id:currentConversationIndex, messages:chatHistory});
request.onsuccess=function(){
updateNavButtons();
updateChatIndexDisplay();
};}
async function sendZeroshotQuery() {
if(isZeroshotProcessing)return;
const zeroshotInput=document.getElementById('zeroshotInput');
if(zeroshotInput.value.trim()==='')return;
try{
isZeroshotProcessing=true;
setButtonLoadingState('zeroshotButton',true);
const response=await fetchAIResponse([{role:'system',content:document.getElementById('zeroshotSystemPrompt').value},{role:'user',content:zeroshotInput.value}]);
zeroshotHistory.push({system:document.getElementById('zeroshotSystemPrompt').value,user:zeroshotInput.value,assistant:response});
updateZeroshotDisplay();
zeroshotInput.value='';
} catch(error){
document.getElementById('errorMessage').textContent=`Error: ${error.message}`;
} finally{
isZeroshotProcessing=false;
setButtonLoadingState('zeroshotButton',false);
}}

function updateZeroshotDisplay() {
const zeroshotHistoryDiv=document.getElementById('zeroshotHistory');
zeroshotHistoryDiv.innerHTML=zeroshotHistory.map(item=>escapeHtml(item.assistant)).reverse().join('<br><br>');
}

function copyCode(button) {
navigator.clipboard.writeText(button.closest('pre').querySelector('code').textContent);
button.textContent='Copied';
setTimeout(()=>button.textContent='Copy',1600);
}

function updateYoutubeUrl() {
document.getElementById('youtubeFrame').src=`${document.getElementById('youtubeUrl').value}${document.getElementById('youtubeUrl').value.includes('?')?'&':'?'}autoplay=1`;
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('hidden');
}

function setButtonLoadingState(buttonId,isLoading) {
const button=document.getElementById(buttonId);
button.disabled=isLoading;
isLoading?(button.dataset.text=button.innerHTML,button.innerHTML='<span class="loadingSpinner"></span>'):button.innerHTML=button.dataset.text;
}

async function fetchAIResponse(messages) {
const apiKey=getApiKey();
if(!apiKey)throw new Error('API key not set. Please enter your API key.');
const response=await fetch(apiUrl,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${apiKey}`},body:JSON.stringify({model:'chatgpt-4o-latest',messages:messages,temperature:1})});
if(!response.ok){
const errorData=await response.json();
throw new Error(`API error: ${errorData.error.message}`);
}
const data=await response.json();
return data.choices[0].message.content;
}

window.onload=function() {
loadApiKey();
openDB();
document.getElementById('userInput').addEventListener('keydown',e=>{
if(e.key==='Enter'&&!e.shiftKey){
e.preventDefault();
sendMessage();
}});
};
</script>
</body>
</html>